"use strict";(globalThis.webpackChunkdocs_site=globalThis.webpackChunkdocs_site||[]).push([[4653],{8453(e,n,t){t.d(n,{R:()=>i,x:()=>l});var s=t(6540);const r={},a=s.createContext(r);function i(e){const n=s.useContext(a);return s.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function l(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:i(e.components),s.createElement(a.Provider,{value:n},e.children)}},8823(e,n,t){t.r(n),t.d(n,{assets:()=>o,contentTitle:()=>l,default:()=>g,frontMatter:()=>i,metadata:()=>s,toc:()=>c});const s=JSON.parse('{"id":"deployment/monitoring","title":"Monitoring","description":"Set up observability for STELLA","source":"@site/docs/deployment/monitoring.md","sourceDirName":"deployment","slug":"/deployment/monitoring","permalink":"/STELLA_backend/docs/deployment/monitoring","draft":false,"unlisted":false,"editUrl":"https://github.com/c4dhi/STELLA_backend/tree/main/docs-site/docs/deployment/monitoring.md","tags":[],"version":"current","sidebarPosition":3,"frontMatter":{"sidebar_position":3,"title":"Monitoring","description":"Set up observability for STELLA"},"sidebar":"docsSidebar","previous":{"title":"Production Checklist","permalink":"/STELLA_backend/docs/deployment/production-checklist"},"next":{"title":"LiveKit","permalink":"/STELLA_backend/docs/integration/livekit"}}');var r=t(4848),a=t(8453);const i={sidebar_position:3,title:"Monitoring",description:"Set up observability for STELLA"},l="Monitoring",o={},c=[{value:"Overview",id:"overview",level:2},{value:"Metrics (Prometheus)",id:"metrics-prometheus",level:2},{value:"Backend Metrics",id:"backend-metrics",level:3},{value:"Agent Metrics",id:"agent-metrics",level:3},{value:"Prometheus Configuration",id:"prometheus-configuration",level:3},{value:"Key Dashboards",id:"key-dashboards",level:3},{value:"Logging (Structured)",id:"logging-structured",level:2},{value:"Backend Logging",id:"backend-logging",level:3},{value:"Agent Logging",id:"agent-logging",level:3},{value:"Log Format",id:"log-format",level:3},{value:"Loki Configuration",id:"loki-configuration",level:3},{value:"Tracing (OpenTelemetry)",id:"tracing-opentelemetry",level:2},{value:"Backend Tracing",id:"backend-tracing",level:3},{value:"Agent Tracing",id:"agent-tracing",level:3},{value:"Jaeger Deployment",id:"jaeger-deployment",level:3},{value:"Alerting",id:"alerting",level:2},{value:"Alert Rules",id:"alert-rules",level:3},{value:"Alertmanager Configuration",id:"alertmanager-configuration",level:3},{value:"Grafana Dashboards",id:"grafana-dashboards",level:2},{value:"Dashboard JSON",id:"dashboard-json",level:3},{value:"Health Checks",id:"health-checks",level:2},{value:"Kubernetes Probes",id:"kubernetes-probes",level:3},{value:"Health Endpoints",id:"health-endpoints",level:3},{value:"Next Steps",id:"next-steps",level:2}];function d(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,a.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.header,{children:(0,r.jsx)(n.h1,{id:"monitoring",children:"Monitoring"})}),"\n",(0,r.jsx)(n.p,{children:"Comprehensive monitoring is essential for running STELLA in production. This guide covers metrics, logging, tracing, and alerting."}),"\n",(0,r.jsx)(n.h2,{id:"overview",children:"Overview"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                     Monitoring Stack                         \u2502\n\u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510         \u2502\n\u2502  \u2502 Prometheus  \u2502  \u2502    Loki     \u2502  \u2502   Jaeger    \u2502         \u2502\n\u2502  \u2502  (Metrics)  \u2502  \u2502  (Logging)  \u2502  \u2502  (Tracing)  \u2502         \u2502\n\u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518         \u2502\n\u2502         \u2502                \u2502                \u2502                 \u2502\n\u2502         \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518                 \u2502\n\u2502                          \u25bc                                  \u2502\n\u2502                   \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510                           \u2502\n\u2502                   \u2502   Grafana   \u2502                           \u2502\n\u2502                   \u2502 (Dashboards)\u2502                           \u2502\n\u2502                   \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518                           \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n"})}),"\n",(0,r.jsx)(n.h2,{id:"metrics-prometheus",children:"Metrics (Prometheus)"}),"\n",(0,r.jsx)(n.h3,{id:"backend-metrics",children:"Backend Metrics"}),"\n",(0,r.jsxs)(n.p,{children:["STELLA exposes Prometheus metrics at ",(0,r.jsx)(n.code,{children:"/metrics"}),":"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"// Key metrics exposed\nstella_http_requests_total         // Total HTTP requests\nstella_http_request_duration       // Request latency histogram\nstella_sessions_active             // Current active sessions\nstella_sessions_created_total      // Total sessions created\nstella_agent_pods_active           // Running agent pods\nstella_database_connections        // DB connection pool status\n"})}),"\n",(0,r.jsx)(n.h3,{id:"agent-metrics",children:"Agent Metrics"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-python",children:"# Agent metrics (Python)\nfrom prometheus_client import Counter, Histogram, Gauge\n\nmessages_processed = Counter(\n    'stella_agent_messages_total',\n    'Total messages processed',\n    ['agent_type', 'direction']\n)\n\nresponse_latency = Histogram(\n    'stella_agent_response_seconds',\n    'Response generation latency',\n    ['agent_type'],\n    buckets=[0.1, 0.5, 1.0, 2.0, 5.0, 10.0]\n)\n\nactive_conversations = Gauge(\n    'stella_agent_conversations_active',\n    'Active conversations',\n    ['agent_type']\n)\n"})}),"\n",(0,r.jsx)(n.h3,{id:"prometheus-configuration",children:"Prometheus Configuration"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:"# prometheus.yml\nglobal:\n  scrape_interval: 15s\n\nscrape_configs:\n  # Backend API\n  - job_name: 'stella-backend'\n    kubernetes_sd_configs:\n      - role: pod\n        namespaces:\n          names: ['ai-agents']\n    relabel_configs:\n      - source_labels: [__meta_kubernetes_pod_label_app]\n        regex: session-management-server\n        action: keep\n\n  # Agent pods\n  - job_name: 'stella-agents'\n    kubernetes_sd_configs:\n      - role: pod\n        namespaces:\n          names: ['ai-agents']\n    relabel_configs:\n      - source_labels: [__meta_kubernetes_pod_label_app]\n        regex: stella-agent\n        action: keep\n"})}),"\n",(0,r.jsx)(n.h3,{id:"key-dashboards",children:"Key Dashboards"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"System Overview:"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Active sessions"}),"\n",(0,r.jsx)(n.li,{children:"Request rate"}),"\n",(0,r.jsx)(n.li,{children:"Error rate"}),"\n",(0,r.jsx)(n.li,{children:"Average latency"}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Agent Performance:"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Response latency distribution"}),"\n",(0,r.jsx)(n.li,{children:"Messages per minute"}),"\n",(0,r.jsx)(n.li,{children:"Tool execution time"}),"\n",(0,r.jsx)(n.li,{children:"STT/TTS latency"}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Infrastructure:"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Pod resource usage"}),"\n",(0,r.jsx)(n.li,{children:"Database connections"}),"\n",(0,r.jsx)(n.li,{children:"Node resource utilization"}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"logging-structured",children:"Logging (Structured)"}),"\n",(0,r.jsx)(n.h3,{id:"backend-logging",children:"Backend Logging"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"// Structured JSON logging\nimport { Logger } from '@nestjs/common';\n\nthis.logger.log({\n  message: 'Session created',\n  sessionId: session.id,\n  projectId: session.projectId,\n  agentType: session.agentType,\n  duration_ms: Date.now() - startTime\n});\n"})}),"\n",(0,r.jsx)(n.h3,{id:"agent-logging",children:"Agent Logging"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-python",children:'import structlog\n\nlogger = structlog.get_logger()\n\nlogger.info(\n    "message_processed",\n    session_id=self.session_id,\n    speaker="user",\n    text_length=len(text),\n    processing_time_ms=processing_time * 1000\n)\n'})}),"\n",(0,r.jsx)(n.h3,{id:"log-format",children:"Log Format"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-json",children:'{\n  "timestamp": "2024-01-15T10:30:00.000Z",\n  "level": "info",\n  "message": "Session created",\n  "service": "stella-backend",\n  "session_id": "abc123",\n  "project_id": "proj456",\n  "agent_type": "stella-agent",\n  "duration_ms": 150,\n  "trace_id": "trace789"\n}\n'})}),"\n",(0,r.jsx)(n.h3,{id:"loki-configuration",children:"Loki Configuration"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:"# Promtail config for Kubernetes\nscrape_configs:\n  - job_name: kubernetes-pods\n    kubernetes_sd_configs:\n      - role: pod\n    pipeline_stages:\n      - json:\n          expressions:\n            level: level\n            session_id: session_id\n            trace_id: trace_id\n      - labels:\n          level:\n          session_id:\n"})}),"\n",(0,r.jsx)(n.h2,{id:"tracing-opentelemetry",children:"Tracing (OpenTelemetry)"}),"\n",(0,r.jsx)(n.h3,{id:"backend-tracing",children:"Backend Tracing"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"// Instrument with OpenTelemetry\nimport { trace } from '@opentelemetry/api';\n\nconst tracer = trace.getTracer('stella-backend');\n\nasync function createSession(dto: CreateSessionDto) {\n  const span = tracer.startSpan('session.create');\n\n  try {\n    span.setAttribute('project_id', dto.projectId);\n    span.setAttribute('agent_type', dto.agentType);\n\n    const session = await this.prisma.session.create({ ... });\n\n    span.setAttribute('session_id', session.id);\n    return session;\n  } catch (error) {\n    span.recordException(error);\n    throw error;\n  } finally {\n    span.end();\n  }\n}\n"})}),"\n",(0,r.jsx)(n.h3,{id:"agent-tracing",children:"Agent Tracing"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-python",children:'from opentelemetry import trace\n\ntracer = trace.get_tracer(__name__)\n\nasync def generate_response(self, text: str):\n    with tracer.start_as_current_span("generate_response") as span:\n        span.set_attribute("input_length", len(text))\n\n        # LLM call\n        with tracer.start_span("llm_call"):\n            response = await self.openai.chat.completions.create(...)\n\n        span.set_attribute("output_length", len(response))\n        return response\n'})}),"\n",(0,r.jsx)(n.h3,{id:"jaeger-deployment",children:"Jaeger Deployment"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:'apiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: jaeger\n  namespace: monitoring\nspec:\n  replicas: 1\n  selector:\n    matchLabels:\n      app: jaeger\n  template:\n    spec:\n      containers:\n        - name: jaeger\n          image: jaegertracing/all-in-one:latest\n          ports:\n            - containerPort: 16686  # UI\n            - containerPort: 4318   # OTLP HTTP\n          env:\n            - name: COLLECTOR_OTLP_ENABLED\n              value: "true"\n'})}),"\n",(0,r.jsx)(n.h2,{id:"alerting",children:"Alerting"}),"\n",(0,r.jsx)(n.h3,{id:"alert-rules",children:"Alert Rules"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:'# prometheus-rules.yml\ngroups:\n  - name: stella-alerts\n    rules:\n      # High error rate\n      - alert: HighErrorRate\n        expr: |\n          sum(rate(stella_http_requests_total{status=~"5.."}[5m]))\n          / sum(rate(stella_http_requests_total[5m])) > 0.05\n        for: 5m\n        labels:\n          severity: critical\n        annotations:\n          summary: High error rate detected\n          description: Error rate is above 5%\n\n      # Slow responses\n      - alert: HighLatency\n        expr: |\n          histogram_quantile(0.95,\n            rate(stella_http_request_duration_bucket[5m])\n          ) > 2\n        for: 5m\n        labels:\n          severity: warning\n        annotations:\n          summary: High latency detected\n          description: P95 latency is above 2 seconds\n\n      # Too many active sessions\n      - alert: HighSessionCount\n        expr: stella_sessions_active > 100\n        for: 10m\n        labels:\n          severity: warning\n        annotations:\n          summary: High number of active sessions\n\n      # Agent pod failures\n      - alert: AgentPodFailures\n        expr: |\n          increase(kube_pod_container_status_restarts_total{\n            namespace="ai-agents",\n            container="agent"\n          }[1h]) > 5\n        for: 5m\n        labels:\n          severity: critical\n        annotations:\n          summary: Agent pods restarting frequently\n'})}),"\n",(0,r.jsx)(n.h3,{id:"alertmanager-configuration",children:"Alertmanager Configuration"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:"# alertmanager.yml\nroute:\n  receiver: 'slack'\n  group_wait: 30s\n  group_interval: 5m\n  repeat_interval: 4h\n  routes:\n    - match:\n        severity: critical\n      receiver: 'pagerduty'\n\nreceivers:\n  - name: 'slack'\n    slack_configs:\n      - api_url: 'https://hooks.slack.com/...'\n        channel: '#stella-alerts'\n\n  - name: 'pagerduty'\n    pagerduty_configs:\n      - service_key: '...'\n"})}),"\n",(0,r.jsx)(n.h2,{id:"grafana-dashboards",children:"Grafana Dashboards"}),"\n",(0,r.jsx)(n.h3,{id:"dashboard-json",children:"Dashboard JSON"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-json",children:'{\n  "dashboard": {\n    "title": "STELLA Overview",\n    "panels": [\n      {\n        "title": "Active Sessions",\n        "type": "stat",\n        "targets": [{\n          "expr": "stella_sessions_active"\n        }]\n      },\n      {\n        "title": "Request Rate",\n        "type": "graph",\n        "targets": [{\n          "expr": "rate(stella_http_requests_total[5m])"\n        }]\n      },\n      {\n        "title": "Error Rate",\n        "type": "graph",\n        "targets": [{\n          "expr": "sum(rate(stella_http_requests_total{status=~\\"5..\\"}[5m])) / sum(rate(stella_http_requests_total[5m]))"\n        }]\n      },\n      {\n        "title": "Response Latency",\n        "type": "heatmap",\n        "targets": [{\n          "expr": "rate(stella_http_request_duration_bucket[5m])"\n        }]\n      }\n    ]\n  }\n}\n'})}),"\n",(0,r.jsx)(n.h2,{id:"health-checks",children:"Health Checks"}),"\n",(0,r.jsx)(n.h3,{id:"kubernetes-probes",children:"Kubernetes Probes"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:"spec:\n  containers:\n    - name: backend\n      livenessProbe:\n        httpGet:\n          path: /health\n          port: 3000\n        initialDelaySeconds: 30\n        periodSeconds: 10\n\n      readinessProbe:\n        httpGet:\n          path: /health/ready\n          port: 3000\n        initialDelaySeconds: 5\n        periodSeconds: 5\n"})}),"\n",(0,r.jsx)(n.h3,{id:"health-endpoints",children:"Health Endpoints"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"// Backend health endpoints\n@Controller('health')\nexport class HealthController {\n  @Get()\n  health() {\n    return { status: 'healthy', timestamp: new Date() };\n  }\n\n  @Get('ready')\n  async ready() {\n    // Check database connection\n    await this.prisma.$queryRaw`SELECT 1`;\n    return { status: 'ready' };\n  }\n}\n"})}),"\n",(0,r.jsx)(n.h2,{id:"next-steps",children:"Next Steps"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.a,{href:"/docs/deployment/production-checklist",children:"Production Checklist"})," - Go-live checklist"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.a,{href:"/docs/deployment/kubernetes",children:"Kubernetes Deployment"})," - Deployment guide"]}),"\n"]})]})}function g(e={}){const{wrapper:n}={...(0,a.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(d,{...e})}):d(e)}}}]);