"use strict";(globalThis.webpackChunkdocs_site=globalThis.webpackChunkdocs_site||[]).push([[4752],{3244(e,n,i){i.r(n),i.d(n,{assets:()=>d,contentTitle:()=>s,default:()=>u,frontMatter:()=>t,metadata:()=>o,toc:()=>c});const o=JSON.parse('{"id":"integration/livekit-production","title":"LiveKit Production","description":"Guide for configuring LiveKit for production with WebRTC and TURN support.","source":"@site/docs/integration/livekit-production.md","sourceDirName":"integration","slug":"/integration/livekit-production","permalink":"/STELLA_backend/docs/integration/livekit-production","draft":false,"unlisted":false,"editUrl":"https://github.com/c4dhi/STELLA_backend/tree/main/docs-site/docs/integration/livekit-production.md","tags":[],"version":"current","sidebarPosition":2,"frontMatter":{"sidebar_position":2,"title":"LiveKit Production"},"sidebar":"docsSidebar","previous":{"title":"LiveKit","permalink":"/STELLA_backend/docs/integration/livekit"},"next":{"title":"Frontend Integration","permalink":"/STELLA_backend/docs/integration/frontend"}}');var r=i(4848),l=i(8453);const t={sidebar_position:2,title:"LiveKit Production"},s="LiveKit Production Setup",d={},c=[{value:"Overview",id:"overview",level:2},{value:"Why TURN on Port 443?",id:"why-turn-on-port-443",level:2},{value:"Firewall Configuration",id:"firewall-configuration",level:2},{value:"Nginx Configuration",id:"nginx-configuration",level:2},{value:"Add TURN Endpoint",id:"add-turn-endpoint",level:3},{value:"Apply Configuration",id:"apply-configuration",level:3},{value:"Connection Flow",id:"connection-flow",level:2},{value:"Verification",id:"verification",level:2},{value:"Check Ports are Open",id:"check-ports-are-open",level:3},{value:"Test Nginx Proxy",id:"test-nginx-proxy",level:3},{value:"Test from Client",id:"test-from-client",level:3},{value:"LiveKit Cloud vs Self-Hosted",id:"livekit-cloud-vs-self-hosted",level:2},{value:"LiveKit Cloud (Recommended)",id:"livekit-cloud-recommended",level:3},{value:"Self-Hosted LiveKit",id:"self-hosted-livekit",level:3},{value:"Troubleshooting",id:"troubleshooting",level:2},{value:"&quot;could not establish pc connection&quot;",id:"could-not-establish-pc-connection",level:3},{value:"Works on WiFi but Not Mobile Data",id:"works-on-wifi-but-not-mobile-data",level:3},{value:"Nginx Returns 502 Bad Gateway",id:"nginx-returns-502-bad-gateway",level:3},{value:"&quot;could not resolve external IP&quot;",id:"could-not-resolve-external-ip",level:3},{value:"&quot;one of key-file or keys must be provided&quot;",id:"one-of-key-file-or-keys-must-be-provided",level:3},{value:"Monitoring",id:"monitoring",level:2},{value:"Summary",id:"summary",level:2},{value:"Minimal Required Changes",id:"minimal-required-changes",level:3},{value:"Result",id:"result",level:3},{value:"See Also",id:"see-also",level:2}];function a(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,l.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.header,{children:(0,r.jsx)(n.h1,{id:"livekit-production-setup",children:"LiveKit Production Setup"})}),"\n",(0,r.jsx)(n.p,{children:"Guide for configuring LiveKit for production with WebRTC and TURN support."}),"\n",(0,r.jsx)(n.h2,{id:"overview",children:"Overview"}),"\n",(0,r.jsx)(n.p,{children:"For production deployments, LiveKit needs additional configuration to work reliably across different network conditions:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"UDP Multiplexing"})," (ports 7882-7892) for efficient RTC connections"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"TURN over TLS"})," (port 443) for maximum compatibility through firewalls"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"WebSocket signaling"})," (port 7880) via nginx"]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"why-turn-on-port-443",children:"Why TURN on Port 443?"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Port 443 (HTTPS) is allowed through ",(0,r.jsx)(n.strong,{children:"all firewalls"})]}),"\n",(0,r.jsx)(n.li,{children:"Mobile carrier firewalls block random UDP ports"}),"\n",(0,r.jsx)(n.li,{children:"Corporate firewalls allow only HTTP/HTTPS ](../443)"}),"\n",(0,r.jsx)(n.li,{children:"TURN over TLS on 443 works everywhere"}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"firewall-configuration",children:"Firewall Configuration"}),"\n",(0,r.jsx)(n.p,{children:"Open the required ports:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"# TURN ports\nsudo ufw allow 30443/tcp   # TURN over TLS\nsudo ufw allow 30444/udp   # TURN over UDP\n\n# UDP multiplexing range\nsudo ufw allow 30882:30892/udp\n\n# Verify\nsudo ufw status\n"})}),"\n",(0,r.jsx)(n.h2,{id:"nginx-configuration",children:"Nginx Configuration"}),"\n",(0,r.jsx)(n.h3,{id:"add-turn-endpoint",children:"Add TURN Endpoint"}),"\n",(0,r.jsx)(n.p,{children:"Update your LiveKit nginx server block:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-nginx",children:'server {\n    server_name livekit.yourdomain.com;\n\n    # Existing WebSocket location (port 7880)\n    location / {\n        proxy_pass http://127.0.0.1:30880;\n        proxy_http_version 1.1;\n        proxy_set_header Upgrade $http_upgrade;\n        proxy_set_header Connection "upgrade";\n        proxy_set_header Host $host;\n        proxy_set_header X-Real-IP $remote_addr;\n        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n        proxy_set_header X-Forwarded-Proto $scheme;\n\n        proxy_connect_timeout 7d;\n        proxy_send_timeout 7d;\n        proxy_read_timeout 7d;\n    }\n\n    # TURN over TLS endpoint\n    location /turn {\n        proxy_pass http://127.0.0.1:30443;\n        proxy_http_version 1.1;\n        proxy_set_header Upgrade $http_upgrade;\n        proxy_set_header Connection "upgrade";\n        proxy_set_header Host $host;\n\n        proxy_connect_timeout 7d;\n        proxy_send_timeout 7d;\n        proxy_read_timeout 7d;\n    }\n\n    listen 443 ssl;\n    ssl_certificate /etc/letsencrypt/live/livekit.yourdomain.com/fullchain.pem;\n    ssl_certificate_key /etc/letsencrypt/live/livekit.yourdomain.com/privkey.pem;\n}\n'})}),"\n",(0,r.jsx)(n.h3,{id:"apply-configuration",children:"Apply Configuration"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"sudo ln -sf /etc/nginx/sites-available/livekit /etc/nginx/sites-enabled/\nsudo nginx -t\nsudo systemctl reload nginx\n"})}),"\n",(0,r.jsx)(n.h2,{id:"connection-flow",children:"Connection Flow"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"1. Frontend \u2192 Backend /livekit/token (HTTPS)\n   \u2514\u2500\u2500 Get LiveKit access token\n\n2. Frontend \u2192 LiveKit wss://livekit.yourdomain.com (via nginx)\n   \u2514\u2500\u2500 WebSocket signaling connection\n\n3. Frontend \u2194 LiveKit Direct UDP (30882-30892)\n   \u2514\u2500\u2500 Media streams (if network allows)\n\n4. Frontend \u2192 LiveKit TURN/TLS (port 443 via nginx)\n   \u2514\u2500\u2500 Fallback for networks blocking UDP\n"})}),"\n",(0,r.jsx)(n.h2,{id:"verification",children:"Verification"}),"\n",(0,r.jsx)(n.h3,{id:"check-ports-are-open",children:"Check Ports are Open"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:'# From production server\nsudo netstat -tulnp | grep -E "(30443|30444|30882|30892)"\n'})}),"\n",(0,r.jsx)(n.h3,{id:"test-nginx-proxy",children:"Test Nginx Proxy"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"# Test WebSocket signaling\ncurl -I https://livekit.yourdomain.com\n\n# Test TURN endpoint (should return 400, not 404)\ncurl -I https://livekit.yourdomain.com/turn\n"})}),"\n",(0,r.jsx)(n.h3,{id:"test-from-client",children:"Test from Client"}),"\n",(0,r.jsx)(n.p,{children:"After deployment:"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsx)(n.li,{children:"Open browser to your frontend"}),"\n",(0,r.jsx)(n.li,{children:"Open DevTools Console (F12)"}),"\n",(0,r.jsx)(n.li,{children:"Start a session"}),"\n",(0,r.jsxs)(n.li,{children:["Look for:","\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"\u2713 [TOKEN] Successfully obtained token from backend\n\ud83d\udd17 Chat connecting to LiveKit room\n[LiveKit] Connected to room\n[RTC] Using TURN server: livekit.yourdomain.com:443\n"})}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"livekit-cloud-vs-self-hosted",children:"LiveKit Cloud vs Self-Hosted"}),"\n",(0,r.jsx)(n.h3,{id:"livekit-cloud-recommended",children:"LiveKit Cloud (Recommended)"}),"\n",(0,r.jsxs)(n.p,{children:["If using ",(0,r.jsx)(n.a,{href:"https://livekit.io/cloud",children:"LiveKit Cloud"}),":"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"TURN is handled automatically"}),"\n",(0,r.jsx)(n.li,{children:"No firewall configuration needed"}),"\n",(0,r.jsx)(n.li,{children:"Just configure your API keys"}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"LIVEKIT_URL=wss://your-project.livekit.cloud\nPUBLIC_LIVEKIT_URL=wss://your-project.livekit.cloud\nLIVEKIT_API_KEY=your-api-key\nLIVEKIT_API_SECRET=your-api-secret\n"})}),"\n",(0,r.jsx)(n.h3,{id:"self-hosted-livekit",children:"Self-Hosted LiveKit"}),"\n",(0,r.jsx)(n.p,{children:"For self-hosted deployments, configure TURN in your LiveKit config:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:"turn:\n  enabled: true\n  domain: livekit.yourdomain.com\n  tls_port: 443\n  udp_port: 443\n\nrtc:\n  port_range_start: 50000\n  port_range_end: 60000\n  tcp_port: 7881\n  use_external_ip: false\n  node_ip: livekit.yourdomain.com\n"})}),"\n",(0,r.jsx)(n.h2,{id:"troubleshooting",children:"Troubleshooting"}),"\n",(0,r.jsx)(n.h3,{id:"could-not-establish-pc-connection",children:'"could not establish pc connection"'}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Symptoms:"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"WebSocket connects (token fetch works)"}),"\n",(0,r.jsx)(n.li,{children:"WebRTC peer connection fails"}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Solution:"}),"\nCheck firewall ports:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:'sudo ufw status | grep -E "(30443|30444|3088[0-9]|3089[0-9])"\n'})}),"\n",(0,r.jsx)(n.h3,{id:"works-on-wifi-but-not-mobile-data",children:"Works on WiFi but Not Mobile Data"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Symptoms:"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Connects fine on WiFi"}),"\n",(0,r.jsx)(n.li,{children:"Fails on cellular/4G/5G"}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Solution:"}),"\nMobile carriers require TURN. Verify:"]}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsx)(n.li,{children:"Nginx TURN proxy is configured"}),"\n",(0,r.jsx)(n.li,{children:"Ports 30443/30444 are open"}),"\n",(0,r.jsx)(n.li,{children:"LiveKit config has TURN enabled"}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"nginx-returns-502-bad-gateway",children:"Nginx Returns 502 Bad Gateway"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Solution:"}),"\nCheck if LiveKit pod is running:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"kubectl get pods -n ai-agents -l app=livekit\nkubectl logs -n ai-agents -l app=livekit --tail=50\n"})}),"\n",(0,r.jsx)(n.h3,{id:"could-not-resolve-external-ip",children:'"could not resolve external IP"'}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Symptoms:"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"LiveKit pod keeps restarting"}),"\n",(0,r.jsxs)(n.li,{children:["Logs show: ",(0,r.jsx)(n.code,{children:"could not resolve external IP: context deadline exceeded"})]}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Solution:"}),"\nUse ",(0,r.jsx)(n.code,{children:"node_ip"})," instead of ",(0,r.jsx)(n.code,{children:"use_external_ip: true"})," in LiveKit config:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:"rtc:\n  use_external_ip: false\n  node_ip: livekit.yourdomain.com\n"})}),"\n",(0,r.jsx)(n.h3,{id:"one-of-key-file-or-keys-must-be-provided",children:'"one of key-file or keys must be provided"'}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Symptoms:"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"LiveKit pod crashes immediately"}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Solution:"}),"\nEnsure your LiveKit config includes API keys:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:"keys:\n  your-api-key: your-api-secret\n"})}),"\n",(0,r.jsx)(n.h2,{id:"monitoring",children:"Monitoring"}),"\n",(0,r.jsx)(n.p,{children:"Check LiveKit logs for TURN usage:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"kubectl logs -n ai-agents -l app=livekit -f | grep -i turn\n"})}),"\n",(0,r.jsx)(n.p,{children:"Expected logs:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"[INFO] TURN allocation created for peer X\n[INFO] Using TURN relay for connection\n[INFO] TURN session established: candidate-type=relay\n"})}),"\n",(0,r.jsx)(n.h2,{id:"summary",children:"Summary"}),"\n",(0,r.jsx)(n.h3,{id:"minimal-required-changes",children:"Minimal Required Changes"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Firewall"}),": Open ",(0,r.jsx)(n.code,{children:"30443/tcp"}),", ",(0,r.jsx)(n.code,{children:"30444/udp"}),", ",(0,r.jsx)(n.code,{children:"30882-30892/udp"})]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Nginx"}),": Add ",(0,r.jsx)(n.code,{children:"/turn"})," location proxy to port 30443"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Deploy"}),": ",(0,r.jsx)(n.code,{children:"./scripts/start-k8s.sh --production"})]}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"result",children:"Result"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"99%+ connection success rate"}),"\n",(0,r.jsx)(n.li,{children:"Works on mobile cellular networks"}),"\n",(0,r.jsx)(n.li,{children:"Works behind corporate firewalls"}),"\n",(0,r.jsx)(n.li,{children:"Supports unlimited rooms"}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"see-also",children:"See Also"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"/docs/integration/livekit",children:"LiveKit Integration"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"/docs/deployment/nginx-setup",children:"Nginx Setup"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"/docs/deployment/production",children:"Production Deployment"})}),"\n"]})]})}function u(e={}){const{wrapper:n}={...(0,l.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(a,{...e})}):a(e)}},8453(e,n,i){i.d(n,{R:()=>t,x:()=>s});var o=i(6540);const r={},l=o.createContext(r);function t(e){const n=o.useContext(l);return o.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function s(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:t(e.components),o.createElement(l.Provider,{value:n},e.children)}}}]);