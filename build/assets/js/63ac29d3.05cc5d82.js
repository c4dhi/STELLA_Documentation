"use strict";(globalThis.webpackChunkdocs_site=globalThis.webpackChunkdocs_site||[]).push([[4022],{4783(e,n,s){s.r(n),s.d(n,{assets:()=>c,contentTitle:()=>o,default:()=>p,frontMatter:()=>r,metadata:()=>t,toc:()=>d});const t=JSON.parse('{"id":"architecture/kubernetes-orchestration","title":"Kubernetes Orchestration","description":"How STELLA manages agent pods in Kubernetes","source":"@site/docs/architecture/kubernetes-orchestration.md","sourceDirName":"architecture","slug":"/architecture/kubernetes-orchestration","permalink":"/STELLA_backend/docs/architecture/kubernetes-orchestration","draft":false,"unlisted":false,"editUrl":"https://github.com/c4dhi/STELLA_backend/tree/main/docs-site/docs/architecture/kubernetes-orchestration.md","tags":[],"version":"current","sidebarPosition":4,"frontMatter":{"sidebar_position":4,"title":"Kubernetes Orchestration","description":"How STELLA manages agent pods in Kubernetes"},"sidebar":"docsSidebar","previous":{"title":"Database Schema","permalink":"/STELLA_backend/docs/architecture/database"},"next":{"title":"Environment Variables","permalink":"/STELLA_backend/docs/architecture/environment-variables"}}');var i=s(4848),a=s(8453);const r={sidebar_position:4,title:"Kubernetes Orchestration",description:"How STELLA manages agent pods in Kubernetes"},o="Kubernetes Orchestration",c={},d=[{value:"Architecture",id:"architecture",level:2},{value:"Pod Lifecycle",id:"pod-lifecycle",level:2},{value:"1. Session Created",id:"1-session-created",level:3},{value:"2. Pod Specification",id:"2-pod-specification",level:3},{value:"3. Pod Monitoring",id:"3-pod-monitoring",level:3},{value:"4. Session Termination",id:"4-session-termination",level:3},{value:"Resource Management",id:"resource-management",level:2},{value:"Resource Limits by Agent Type",id:"resource-limits-by-agent-type",level:3},{value:"Namespace Quotas",id:"namespace-quotas",level:3},{value:"Limit Ranges",id:"limit-ranges",level:3},{value:"Pod Security",id:"pod-security",level:2},{value:"Secret Management",id:"secret-management",level:3},{value:"Security Context",id:"security-context",level:3},{value:"Network Policies",id:"network-policies",level:3},{value:"Scaling Considerations",id:"scaling-considerations",level:2},{value:"Horizontal Pod Autoscaling",id:"horizontal-pod-autoscaling",level:3},{value:"Node Affinity",id:"node-affinity",level:3},{value:"Monitoring",id:"monitoring",level:2},{value:"Pod Metrics",id:"pod-metrics",level:3},{value:"Health Checks",id:"health-checks",level:3},{value:"Next Steps",id:"next-steps",level:2}];function l(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",p:"p",pre:"pre",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,a.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.header,{children:(0,i.jsx)(n.h1,{id:"kubernetes-orchestration",children:"Kubernetes Orchestration"})}),"\n",(0,i.jsx)(n.p,{children:"STELLA uses Kubernetes to dynamically deploy and manage AI agent pods. Each conversation session gets its own isolated pod with dedicated resources."}),"\n",(0,i.jsx)(n.h2,{id:"architecture",children:"Architecture"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                     Kubernetes Cluster                       \u2502\n\u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510 \u2502\n\u2502  \u2502                  Namespace: ai-agents                   \u2502 \u2502\n\u2502  \u2502                                                         \u2502 \u2502\n\u2502  \u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510  Manages   \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510   \u2502 \u2502\n\u2502  \u2502  \u2502   Backend   \u2502\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u25b6 \u2502    Agent Pods        \u2502   \u2502 \u2502\n\u2502  \u2502  \u2502  (NestJS)   \u2502            \u2502  \u250c\u2500\u2500\u2500\u2500\u2510 \u250c\u2500\u2500\u2500\u2500\u2510 \u250c\u2500\u2500\u2500\u2510 \u2502   \u2502 \u2502\n\u2502  \u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518            \u2502  \u2502Pod1\u2502 \u2502Pod2\u2502 \u2502...\u2502 \u2502   \u2502 \u2502\n\u2502  \u2502        \u2502                    \u2502  \u2514\u2500\u2500\u2500\u2500\u2518 \u2514\u2500\u2500\u2500\u2500\u2518 \u2514\u2500\u2500\u2500\u2518 \u2502   \u2502 \u2502\n\u2502  \u2502        \u2502                    \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518   \u2502 \u2502\n\u2502  \u2502        \u2502                                               \u2502 \u2502\n\u2502  \u2502        \u25bc                                               \u2502 \u2502\n\u2502  \u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510            \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510   \u2502 \u2502\n\u2502  \u2502  \u2502  Secrets    \u2502            \u2502   ConfigMaps         \u2502   \u2502 \u2502\n\u2502  \u2502  \u2502  (per pod)  \u2502            \u2502   (shared config)    \u2502   \u2502 \u2502\n\u2502  \u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518            \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518   \u2502 \u2502\n\u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518 \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n"})}),"\n",(0,i.jsx)(n.h2,{id:"pod-lifecycle",children:"Pod Lifecycle"}),"\n",(0,i.jsx)(n.h3,{id:"1-session-created",children:"1. Session Created"}),"\n",(0,i.jsx)(n.p,{children:"When a session is created, the backend prepares the Kubernetes resources:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",children:"// Backend creates session\nasync createSession(dto: CreateSessionDto) {\n  // 1. Create session record in database\n  const session = await this.prisma.session.create({\n    data: {\n      projectId: dto.projectId,\n      agentType: dto.agentType,\n      status: 'PENDING'\n    }\n  });\n\n  // 2. Create Kubernetes secret with credentials\n  await this.k8s.createSecret(session.id, {\n    LIVEKIT_URL: process.env.LIVEKIT_URL,\n    LIVEKIT_API_KEY: process.env.LIVEKIT_API_KEY,\n    LIVEKIT_API_SECRET: process.env.LIVEKIT_API_SECRET,\n    OPENAI_API_KEY: process.env.OPENAI_API_KEY,\n    ROOM_NAME: session.roomName,\n    SESSION_ID: session.id\n  });\n\n  // 3. Create agent pod\n  await this.k8s.createAgentPod(session.id, dto.agentType);\n\n  return session;\n}\n"})}),"\n",(0,i.jsx)(n.h3,{id:"2-pod-specification",children:"2. Pod Specification"}),"\n",(0,i.jsx)(n.p,{children:"Agent pods are created with specific resource requirements:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:'apiVersion: v1\nkind: Pod\nmetadata:\n  name: agent-{session-id}\n  namespace: ai-agents\n  labels:\n    app: stella-agent\n    session: {session-id}\n    agent-type: stella-agent\nspec:\n  containers:\n  - name: agent\n    image: ghcr.io/c4dhi/stella-agent:latest\n    envFrom:\n    - secretRef:\n        name: agent-secret-{session-id}\n    resources:\n      requests:\n        cpu: "250m"\n        memory: "512Mi"\n      limits:\n        cpu: "1000m"\n        memory: "2Gi"\n    livenessProbe:\n      httpGet:\n        path: /health\n        port: 8080\n      initialDelaySeconds: 30\n      periodSeconds: 10\n    readinessProbe:\n      httpGet:\n        path: /ready\n        port: 8080\n      initialDelaySeconds: 5\n      periodSeconds: 5\n  restartPolicy: Never\n  terminationGracePeriodSeconds: 30\n'})}),"\n",(0,i.jsx)(n.h3,{id:"3-pod-monitoring",children:"3. Pod Monitoring"}),"\n",(0,i.jsx)(n.p,{children:"The backend watches pod status changes:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",children:"// Watch for pod status changes\nk8sWatch.watch(\n  '/api/v1/namespaces/ai-agents/pods',\n  { labelSelector: 'app=stella-agent' },\n  (type, pod) => {\n    const sessionId = pod.metadata.labels.session;\n\n    switch (type) {\n      case 'MODIFIED':\n        if (pod.status.phase === 'Running') {\n          // Pod is ready, update session status\n          this.updateSessionStatus(sessionId, 'ACTIVE');\n        }\n        break;\n\n      case 'DELETED':\n        // Pod was deleted, clean up session\n        this.handlePodDeleted(sessionId);\n        break;\n    }\n  }\n);\n"})}),"\n",(0,i.jsx)(n.h3,{id:"4-session-termination",children:"4. Session Termination"}),"\n",(0,i.jsx)(n.p,{children:"When a session ends, resources are cleaned up:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",children:"async endSession(sessionId: string) {\n  // 1. Update session status\n  await this.prisma.session.update({\n    where: { id: sessionId },\n    data: { status: 'ENDING' }\n  });\n\n  // 2. Delete the pod (triggers graceful shutdown)\n  await this.k8s.deleteNamespacedPod(\n    `agent-${sessionId}`,\n    'ai-agents'\n  );\n\n  // 3. Delete the secret\n  await this.k8s.deleteNamespacedSecret(\n    `agent-secret-${sessionId}`,\n    'ai-agents'\n  );\n\n  // 4. Mark session as ended\n  await this.prisma.session.update({\n    where: { id: sessionId },\n    data: {\n      status: 'ENDED',\n      endedAt: new Date()\n    }\n  });\n}\n"})}),"\n",(0,i.jsx)(n.h2,{id:"resource-management",children:"Resource Management"}),"\n",(0,i.jsx)(n.h3,{id:"resource-limits-by-agent-type",children:"Resource Limits by Agent Type"}),"\n",(0,i.jsxs)(n.table,{children:[(0,i.jsx)(n.thead,{children:(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.th,{children:"Agent Type"}),(0,i.jsx)(n.th,{children:"CPU Request"}),(0,i.jsx)(n.th,{children:"CPU Limit"}),(0,i.jsx)(n.th,{children:"Memory Request"}),(0,i.jsx)(n.th,{children:"Memory Limit"})]})}),(0,i.jsxs)(n.tbody,{children:[(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"stella-agent"}),(0,i.jsx)(n.td,{children:"250m"}),(0,i.jsx)(n.td,{children:"1000m"}),(0,i.jsx)(n.td,{children:"512Mi"}),(0,i.jsx)(n.td,{children:"2Gi"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"stella-light"}),(0,i.jsx)(n.td,{children:"100m"}),(0,i.jsx)(n.td,{children:"500m"}),(0,i.jsx)(n.td,{children:"256Mi"}),(0,i.jsx)(n.td,{children:"1Gi"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"echo-agent"}),(0,i.jsx)(n.td,{children:"50m"}),(0,i.jsx)(n.td,{children:"250m"}),(0,i.jsx)(n.td,{children:"128Mi"}),(0,i.jsx)(n.td,{children:"512Mi"})]})]})]}),"\n",(0,i.jsx)(n.h3,{id:"namespace-quotas",children:"Namespace Quotas"}),"\n",(0,i.jsx)(n.p,{children:"Limit total resources in the namespace:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:'apiVersion: v1\nkind: ResourceQuota\nmetadata:\n  name: ai-agents-quota\n  namespace: ai-agents\nspec:\n  hard:\n    requests.cpu: "10"\n    requests.memory: 20Gi\n    limits.cpu: "20"\n    limits.memory: 40Gi\n    pods: "50"\n'})}),"\n",(0,i.jsx)(n.h3,{id:"limit-ranges",children:"Limit Ranges"}),"\n",(0,i.jsx)(n.p,{children:"Set default resource limits for pods:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:'apiVersion: v1\nkind: LimitRange\nmetadata:\n  name: ai-agents-limits\n  namespace: ai-agents\nspec:\n  limits:\n  - default:\n      cpu: "500m"\n      memory: 1Gi\n    defaultRequest:\n      cpu: "100m"\n      memory: "256Mi"\n    type: Container\n'})}),"\n",(0,i.jsx)(n.h2,{id:"pod-security",children:"Pod Security"}),"\n",(0,i.jsx)(n.h3,{id:"secret-management",children:"Secret Management"}),"\n",(0,i.jsx)(n.p,{children:"Secrets are created per-session and contain:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:"apiVersion: v1\nkind: Secret\nmetadata:\n  name: agent-secret-{session-id}\n  namespace: ai-agents\ntype: Opaque\ndata:\n  LIVEKIT_URL: {base64-encoded}\n  LIVEKIT_API_KEY: {base64-encoded}\n  LIVEKIT_API_SECRET: {base64-encoded}\n  OPENAI_API_KEY: {base64-encoded}\n  ROOM_NAME: {base64-encoded}\n  SESSION_ID: {base64-encoded}\n"})}),"\n",(0,i.jsx)(n.h3,{id:"security-context",children:"Security Context"}),"\n",(0,i.jsx)(n.p,{children:"Pods run with restricted permissions:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:"spec:\n  securityContext:\n    runAsNonRoot: true\n    runAsUser: 1000\n    fsGroup: 1000\n  containers:\n  - name: agent\n    securityContext:\n      allowPrivilegeEscalation: false\n      readOnlyRootFilesystem: true\n      capabilities:\n        drop:\n        - ALL\n"})}),"\n",(0,i.jsx)(n.h3,{id:"network-policies",children:"Network Policies"}),"\n",(0,i.jsx)(n.p,{children:"Restrict network access for agent pods:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:"apiVersion: networking.k8s.io/v1\nkind: NetworkPolicy\nmetadata:\n  name: agent-network-policy\n  namespace: ai-agents\nspec:\n  podSelector:\n    matchLabels:\n      app: stella-agent\n  policyTypes:\n  - Egress\n  egress:\n  # Allow DNS\n  - to:\n    - namespaceSelector: {}\n    ports:\n    - protocol: UDP\n      port: 53\n  # Allow LiveKit\n  - to:\n    - ipBlock:\n        cidr: 0.0.0.0/0\n    ports:\n    - protocol: TCP\n      port: 443\n    - protocol: UDP\n      port: 443\n  # Allow OpenAI API\n  - to:\n    - ipBlock:\n        cidr: 0.0.0.0/0\n    ports:\n    - protocol: TCP\n      port: 443\n"})}),"\n",(0,i.jsx)(n.h2,{id:"scaling-considerations",children:"Scaling Considerations"}),"\n",(0,i.jsx)(n.h3,{id:"horizontal-pod-autoscaling",children:"Horizontal Pod Autoscaling"}),"\n",(0,i.jsx)(n.p,{children:"While each session has its own pod, you can use HPA for shared services:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:"apiVersion: autoscaling/v2\nkind: HorizontalPodAutoscaler\nmetadata:\n  name: backend-hpa\nspec:\n  scaleTargetRef:\n    apiVersion: apps/v1\n    kind: Deployment\n    name: session-management-server\n  minReplicas: 2\n  maxReplicas: 10\n  metrics:\n  - type: Resource\n    resource:\n      name: cpu\n      target:\n        type: Utilization\n        averageUtilization: 70\n"})}),"\n",(0,i.jsx)(n.h3,{id:"node-affinity",children:"Node Affinity"}),"\n",(0,i.jsx)(n.p,{children:"Ensure agent pods run on appropriate nodes:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:"spec:\n  affinity:\n    nodeAffinity:\n      requiredDuringSchedulingIgnoredDuringExecution:\n        nodeSelectorTerms:\n        - matchExpressions:\n          - key: workload-type\n            operator: In\n            values:\n            - ai-agents\n"})}),"\n",(0,i.jsx)(n.h2,{id:"monitoring",children:"Monitoring"}),"\n",(0,i.jsx)(n.h3,{id:"pod-metrics",children:"Pod Metrics"}),"\n",(0,i.jsx)(n.p,{children:"Expose metrics for monitoring:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:"# In agent code\nfrom prometheus_client import Counter, Histogram\n\nmessages_processed = Counter(\n    'agent_messages_processed_total',\n    'Total messages processed',\n    ['agent_type', 'session_id']\n)\n\nresponse_latency = Histogram(\n    'agent_response_latency_seconds',\n    'Response generation latency',\n    ['agent_type']\n)\n"})}),"\n",(0,i.jsx)(n.h3,{id:"health-checks",children:"Health Checks"}),"\n",(0,i.jsx)(n.p,{children:"Implement health endpoints:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:'from fastapi import FastAPI\n\napp = FastAPI()\n\n@app.get("/health")\nasync def health():\n    return {"status": "healthy"}\n\n@app.get("/ready")\nasync def ready():\n    if agent.is_connected():\n        return {"status": "ready"}\n    return Response(status_code=503)\n'})}),"\n",(0,i.jsx)(n.h2,{id:"next-steps",children:"Next Steps"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.a,{href:"/docs/architecture/session-lifecycle",children:"Session Lifecycle"})," - Session states"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.a,{href:"/docs/deployment/kubernetes",children:"Deployment Guide"})," - Production deployment"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.a,{href:"/docs/deployment/monitoring",children:"Monitoring"})," - Observability setup"]}),"\n"]})]})}function p(e={}){const{wrapper:n}={...(0,a.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(l,{...e})}):l(e)}},8453(e,n,s){s.d(n,{R:()=>r,x:()=>o});var t=s(6540);const i={},a=t.createContext(i);function r(e){const n=t.useContext(a);return t.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:r(e.components),t.createElement(a.Provider,{value:n},e.children)}}}]);